<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>grpc Demo示例 | 种逗南山-hexo博客</title>
  <meta name="author" content="Liaowz">
  
  <meta name="description" content="grpc简介，grpc Demo示例。">
  
  <meta name="Keywords" content="grpc">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="grpc Demo示例"/>

  <meta property="og:site_name" content="种逗南山-hexo博客"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/img/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="种逗南山-hexo博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">种逗南山-hexo博客</a></h1>
  <h2><a href="/">众里寻他千百度，蓦然回首那人却在灯火阑珊处。</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/about">关于</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-08-23T07:15:32.000Z"><a href="/2017/08/23/151532/">2017-08-23 15:15:32</a></time>
      
      
  
    <h1 class="title">grpc Demo示例</h1>
  

    </header>
    <div class="entry">
      
        <p>grpc简介，grpc Demo示例。<br><a id="more"></a></p>
<blockquote>
<p>grpc是基于protobuf的，它会将protobuf的数据传递给服务器端或者从服务器端传递给对应的客户端，因此grpc是跟protobuf搭配使用的。protobuf本身并不是一个数据传输的库或者框架，它本身是专注于编解码的，换句话说主要是完成了对于一个消息编码的转换或者解码的转换，也就是说协议的一种制定方式，它并不是专注于数据传输这一块，这一点是protobuf和thrift的一个明显的差别。但是消息编码和解码之后一定要通过网络进行传输，这是grpc承担的职责和任务。</p>
</blockquote>
<h3 id="1-github"><a href="#1-github" class="headerlink" title="1.github"></a>1.github</h3><blockquote>
<p><a href="https://github.com/grpc/grpc-java" target="_blank" rel="noopener">https://github.com/grpc/grpc-java</a></p>
</blockquote>
<h3 id="2-gradle依赖"><a href="#2-gradle依赖" class="headerlink" title="2.gradle依赖"></a>2.gradle依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compile(</span><br><span class="line">            &quot;io.grpc:grpc-netty:1.4.0&quot;,</span><br><span class="line">            &quot;io.grpc:grpc-protobuf:1.4.0&quot;,</span><br><span class="line">            &quot;io.grpc:grpc-stub:1.4.0&quot;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h3 id="3-grpc-protobuf插件配置：protobuf-gradle-plugin"><a href="#3-grpc-protobuf插件配置：protobuf-gradle-plugin" class="headerlink" title="3.grpc protobuf插件配置：protobuf-gradle-plugin"></a>3.grpc protobuf插件配置：<a href="https://github.com/google/protobuf-gradle-plugin" target="_blank" rel="noopener">protobuf-gradle-plugin</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        // ASSUMES GRADLE 2.12 OR HIGHER. Use plugin version 0.7.5 with earlier</span><br><span class="line">        // gradle versions</span><br><span class="line">        classpath &apos;com.google.protobuf:protobuf-gradle-plugin:0.8.1&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protobuf &#123;</span><br><span class="line">    protoc &#123;</span><br><span class="line">        artifact = &quot;com.google.protobuf:protoc:3.2.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        grpc &#123;</span><br><span class="line">            artifact = &apos;io.grpc:protoc-gen-grpc-java:1.4.0&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //grpc生成代码目录</span><br><span class="line">    generatedFilesBaseDir = &apos;src&apos;</span><br><span class="line"></span><br><span class="line">    generateProtoTasks &#123;</span><br><span class="line">        all()*.plugins &#123;</span><br><span class="line">            grpc &#123;</span><br><span class="line">	        //grpc生成代码目录</span><br><span class="line">                outputSubDir = &apos;java&apos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gradle其他配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sourceSets&#123;</span><br><span class="line">    main&#123;</span><br><span class="line">        proto&#123;</span><br><span class="line">            srcDir &apos;src/main/grpc&apos;</span><br><span class="line">            srcDir &apos;src/main&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>设置grpc的.proto文件路径，此为src/main/grpc，默认是src/main/proto</p>
</blockquote>
<h3 id="4-编写proto文件"><a href="#4-编写proto文件" class="headerlink" title="4.编写proto文件"></a>4.编写proto文件</h3><blockquote>
<p>src/main目录下新建grpc目录，并新建文件Student.proto如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package com.liaowz.proto;</span><br><span class="line"></span><br><span class="line">option java_package = &quot;com.liaowz.proto&quot;;</span><br><span class="line">option java_outer_classname = &quot;StudentProto&quot;;</span><br><span class="line">option java_multiple_files = true;</span><br><span class="line"></span><br><span class="line">service StudentService &#123;</span><br><span class="line">    rpc GetRealNameByUserName(MyRequest) returns (MyResponse)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    rpc GetStudentsByAge(StudentRequest) returns (stream StudentResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    rpc GetStudentsWrapperByAges(stream StudentRequest) returns (StudentResponseList) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    rpc BiTalk(stream StreamRequest) returns (stream StreamResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message MyRequest&#123;</span><br><span class="line">    string username = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message MyResponse&#123;</span><br><span class="line">    string realname = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message StudentRequest&#123;</span><br><span class="line">    int32 age = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message StudentResponse&#123;</span><br><span class="line">    string name = 1;</span><br><span class="line">    int32 age = 2;</span><br><span class="line">    string city = 3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message StudentResponseList&#123;</span><br><span class="line">    repeated StudentResponse studentResponse = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message StreamRequest&#123;</span><br><span class="line">    string request_info = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message StreamResponse&#123;</span><br><span class="line">    string response_info = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：grpc请求响应必须是message类型，而thrift可以是string或int32类型</p>
</blockquote>
<blockquote>
<p>grpc四种数据传输方式：<br>    rpc GetRealNameByUserName(MyRequest) returns (MyResponse){}</p>
</blockquote>
<pre><code>rpc GetStudentsByAge(StudentRequest) returns (stream StudentResponse) {}

rpc GetStudentsWrapperByAges(stream StudentRequest) returns (StudentResponseList) {}

rpc BiTalk(stream StreamRequest) returns (stream StreamResponse) {}
</code></pre><h3 id="5-编译"><a href="#5-编译" class="headerlink" title="5.编译"></a>5.编译</h3><blockquote>
<p>gradle clean<br>gradle generateProto</p>
</blockquote>
<p>生成的代码在设置的src.main.java.com.liaowz.proto目录中</p>
<h3 id="6-业务实现代码StudentServiceImpl-java"><a href="#6-业务实现代码StudentServiceImpl-java" class="headerlink" title="6.业务实现代码StudentServiceImpl.java"></a>6.业务实现代码StudentServiceImpl.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">package com.liaowz.grpc;</span><br><span class="line"></span><br><span class="line">import io.grpc.stub.StreamObserver;</span><br><span class="line"></span><br><span class="line">import java.util.UUID;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by hasee on 2017/8/30.</span><br><span class="line"> */</span><br><span class="line">public class StudentServiceImpl extends StudentServiceGrpc.StudentServiceImplBase&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void getRealNameByUserName(MyRequest request, StreamObserver&lt;MyResponse&gt; responseObserver) &#123;</span><br><span class="line">        System.out.println(&quot;接收到客户端信息：&quot; + request.getUsername());</span><br><span class="line"></span><br><span class="line">        responseObserver.onNext(MyResponse.newBuilder().setRealname(&quot;张三&quot;).build()); //onNext接下来做什么，通过responseObserver对象返回结果</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void getStudentsByAge(StudentRequest request, StreamObserver&lt;StudentResponse&gt; responseObserver) &#123;</span><br><span class="line">        System.out.println(&quot;接收到客户端信息：&quot; + request.getAge());</span><br><span class="line"></span><br><span class="line">        responseObserver.onNext(StudentResponse.newBuilder().setName(&quot;zhangsan&quot;).setAge(20).setCity(&quot;shanghai&quot;).build());</span><br><span class="line">        responseObserver.onNext(StudentResponse.newBuilder().setName(&quot;zhangsan2&quot;).setAge(30).setCity(&quot;shanghai2&quot;).build());</span><br><span class="line">        responseObserver.onNext(StudentResponse.newBuilder().setName(&quot;zhangsan3&quot;).setAge(50).setCity(&quot;shanghai3&quot;).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public StreamObserver&lt;StudentRequest&gt; getStudentsWrapperByAges(StreamObserver&lt;StudentResponseList&gt; responseObserver) &#123;</span><br><span class="line">        //当回调事件发生，特定回调方法就会执行</span><br><span class="line">        return new StreamObserver&lt;StudentRequest&gt;()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onNext(StudentRequest value) &#123;</span><br><span class="line">                System.out.println(value.getAge());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onError(Throwable t) &#123;</span><br><span class="line">                System.out.println(t.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onCompleted() &#123;</span><br><span class="line">                StudentResponse response1 = StudentResponse.newBuilder().setName(&quot;lisi1&quot;).setAge(20).setCity(&quot;beijing1&quot;).build();</span><br><span class="line">                StudentResponse response2 = StudentResponse.newBuilder().setName(&quot;lisi2&quot;).setAge(20).setCity(&quot;beijing2&quot;).build();</span><br><span class="line">                StudentResponse response3 = StudentResponse.newBuilder().setName(&quot;lisi3&quot;).setAge(20).setCity(&quot;beijing3&quot;).build();</span><br><span class="line"></span><br><span class="line">                StudentResponseList studentResponseList = StudentResponseList.newBuilder().addStudentResponse(response1).</span><br><span class="line">                        addStudentResponse(response2).addStudentResponse(response3).build();</span><br><span class="line"></span><br><span class="line">                responseObserver.onNext(studentResponseList);</span><br><span class="line">                responseObserver.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public StreamObserver&lt;StreamRequest&gt; biTalk(StreamObserver&lt;StreamResponse&gt; responseObserver) &#123;</span><br><span class="line">        return new StreamObserver&lt;StreamRequest&gt;()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onNext(StreamRequest value) &#123;</span><br><span class="line">                System.out.println(value.getRequestInfo());</span><br><span class="line"></span><br><span class="line">                //不同流之间双向数据传递</span><br><span class="line">                responseObserver.onNext(StreamResponse.newBuilder().setResponseInfo(UUID.randomUUID().toString()).build());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onError(Throwable t) &#123;</span><br><span class="line">                System.out.println(t.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onCompleted() &#123;</span><br><span class="line">                responseObserver.onCompleted();//客户端关闭服务器端关闭</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-服务器端GrpcServer-java"><a href="#7-服务器端GrpcServer-java" class="headerlink" title="7.服务器端GrpcServer.java"></a>7.服务器端GrpcServer.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.liaowz.grpc;</span><br><span class="line"></span><br><span class="line">import io.grpc.Server;</span><br><span class="line">import io.grpc.ServerBuilder;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by hasee on 2017/8/30.</span><br><span class="line"> */</span><br><span class="line">public class GrpcServer &#123;</span><br><span class="line"></span><br><span class="line">    private Server server;</span><br><span class="line"></span><br><span class="line">    private void start() throws IOException&#123;</span><br><span class="line">        this.server = ServerBuilder.forPort(8899).addService(new StudentServiceImpl()).build().start();</span><br><span class="line">        System.out.println(&quot;server started!&quot;);</span><br><span class="line"></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(&quot;关闭jvm&quot;);</span><br><span class="line">            GrpcServer.this.stop();</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;执行到这里&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void stop()&#123;</span><br><span class="line">        if(null != this.server)&#123;</span><br><span class="line">            this.server.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void awaitTermination() throws InterruptedException&#123;</span><br><span class="line">        if(null != this.server)&#123;</span><br><span class="line">            this.server.awaitTermination();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException, InterruptedException &#123;</span><br><span class="line">        GrpcServer server = new GrpcServer();</span><br><span class="line"></span><br><span class="line">        server.start();</span><br><span class="line">        server.awaitTermination();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-客户端GrpcClient-java"><a href="#8-客户端GrpcClient-java" class="headerlink" title="8.客户端GrpcClient.java"></a>8.客户端GrpcClient.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">package com.liaowz.grpc;</span><br><span class="line"></span><br><span class="line">import io.grpc.ManagedChannel;</span><br><span class="line">import io.grpc.ManagedChannelBuilder;</span><br><span class="line">import io.grpc.stub.StreamObserver;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.Iterator;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by hasee on 2017/8/30.</span><br><span class="line"> */</span><br><span class="line">public class GrpcClient &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        ManagedChannel managedChannel = ManagedChannelBuilder.forAddress(&quot;127.0.0.1&quot;, 8899).</span><br><span class="line">                usePlaintext(true).build();</span><br><span class="line">        StudentServiceGrpc.StudentServiceBlockingStub blockingStub =</span><br><span class="line">                StudentServiceGrpc.newBlockingStub(managedChannel);</span><br><span class="line"></span><br><span class="line">        StudentServiceGrpc.StudentServiceStub stub = StudentServiceGrpc.newStub(managedChannel); //异步</span><br><span class="line"></span><br><span class="line">        MyResponse myResponse = blockingStub.getRealNameByUserName(MyRequest.newBuilder().setUsername(&quot;zhangsan&quot;).build());</span><br><span class="line"></span><br><span class="line">        System.out.println(myResponse.getRealname());</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;-----------------------&quot;);</span><br><span class="line"></span><br><span class="line">        Iterator&lt;StudentResponse&gt; iterator = blockingStub.getStudentsByAge(StudentRequest.newBuilder().setAge(25).build());</span><br><span class="line">        while (iterator.hasNext())&#123;</span><br><span class="line">            StudentResponse studentResponse = iterator.next();</span><br><span class="line">            System.out.println(studentResponse.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;---------------------------&quot;);</span><br><span class="line"></span><br><span class="line">        StreamObserver&lt;StudentResponseList&gt; studentResponseListStreamObserver = new StreamObserver&lt;StudentResponseList&gt;()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onNext(StudentResponseList value) &#123;</span><br><span class="line">                value.getStudentResponseList().forEach(studentResponse -&gt; &#123;</span><br><span class="line">                    System.out.println(studentResponse.getName());</span><br><span class="line">                    System.out.println(studentResponse.getAge());</span><br><span class="line">                    System.out.println(studentResponse.getCity());</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onError(Throwable t) &#123;</span><br><span class="line">                System.out.println(t.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onCompleted() &#123;</span><br><span class="line">                System.out.println(&quot;completed!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        StreamObserver&lt;StudentRequest&gt; streamObserver = stub.getStudentsWrapperByAges(studentResponseListStreamObserver);</span><br><span class="line">        streamObserver.onNext(StudentRequest.newBuilder().setAge(21).build());</span><br><span class="line">        streamObserver.onNext(StudentRequest.newBuilder().setAge(22).build());</span><br><span class="line">        streamObserver.onNext(StudentRequest.newBuilder().setAge(23).build());</span><br><span class="line"></span><br><span class="line">        streamObserver.onCompleted();</span><br><span class="line">        Thread.sleep(10000L);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;--------------------------------&quot;);</span><br><span class="line"></span><br><span class="line">        StreamObserver&lt;StreamResponse&gt; streamResponseStreamObserver = new StreamObserver&lt;StreamResponse&gt;()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onNext(StreamResponse value) &#123;</span><br><span class="line">                System.out.println(value.getResponseInfo());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onError(Throwable t) &#123;</span><br><span class="line">                System.out.println(t.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onCompleted() &#123;</span><br><span class="line">                System.out.println(&quot;completed!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        StreamObserver&lt;StreamRequest&gt; streamRequestStreamObserver = stub.biTalk(streamResponseStreamObserver);</span><br><span class="line">        for(int i = 0; i&lt; 10;i ++)&#123;</span><br><span class="line">            streamRequestStreamObserver.onNext(StreamRequest.newBuilder().setRequestInfo(LocalDateTime.now().toString()).build());</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        streamRequestStreamObserver.onCompleted();</span><br><span class="line">        Thread.sleep(10000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此处，StudentServiceGrpc.StudentServiceStub stub = StudentServiceGrpc.newStub(managedChannel);<br>只要是客户端以流式向服务端发送请求，一定是异步的，不能用StudentServiceGrpc.newBlockingStub(managedChannel);</p>
</blockquote>
<h3 id="9-运行"><a href="#9-运行" class="headerlink" title="9.运行"></a>9.运行</h3><blockquote>
<p>运行服务端main方法<br>运行客户端main方法</p>
</blockquote>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/netty/">netty</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/grpc/">grpc</a>
  </div>

	<!-- 注释国外分享组件，加载慢
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

	-->
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<!--畅言评论插件start-->
<!--PC和WAP自适应版-->
<div id="SOHUCS" sid="http://www.liaowz.com/2017/08/23/151532/" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cyt4fsQhf'; 
var conf = 'prod_881782ec7502f89f05db305db86c4d4b'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
<!--畅言评论插件end-->




<!-- 注释多说评论插件
<div class="ds-thread" data-thread-key="/2017/08/23/151532/" data-title="grpc Demo示例" data-url="http://www.liaowz.com/2017/08/23/151532/"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"liaowz"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
-->





<!-- 注释原代码
<section id="comment">
  <h1 class="title">留言</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://www.liaowz.com/2017/08/23/151532/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>
-->















</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:www.liaowz.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/cat/">cat</a><small>1</small></li>
  
    <li><a href="/categories/elasticsearch/">elasticsearch</a><small>1</small></li>
  
    <li><a href="/categories/git/">git</a><small>4</small></li>
  
    <li><a href="/categories/hexo/">hexo</a><small>1</small></li>
  
    <li><a href="/categories/idea-IDE/">idea IDE</a><small>2</small></li>
  
    <li><a href="/categories/java8/">java8</a><small>3</small></li>
  
    <li><a href="/categories/jvm/">jvm</a><small>3</small></li>
  
    <li><a href="/categories/kotlin/">kotlin</a><small>3</small></li>
  
    <li><a href="/categories/linux/">linux</a><small>1</small></li>
  
    <li><a href="/categories/mongodb/">mongodb</a><small>1</small></li>
  
    <li><a href="/categories/netty/">netty</a><small>19</small></li>
  
    <li><a href="/categories/python/">python</a><small>4</small></li>
  
    <li><a href="/categories/rabbitmq/">rabbitmq</a><small>3</small></li>
  
    <li><a href="/categories/react/">react</a><small>1</small></li>
  
    <li><a href="/categories/redis/">redis</a><small>4</small></li>
  
    <li><a href="/categories/spring/">spring</a><small>1</small></li>
  
    <li><a href="/categories/springboot/">springboot</a><small>1</small></li>
  
    <li><a href="/categories/tool/">tool</a><small>6</small></li>
  
    <li><a href="/categories/基础/">基础</a><small>4</small></li>
  
    <li><a href="/categories/并发/">并发</a><small>8</small></li>
  
    <li><a href="/categories/数据库/">数据库</a><small>2</small></li>
  
    <li><a href="/categories/架构/">架构</a><small>3</small></li>
  
    <li><a href="/categories/测试/">测试</a><small>1</small></li>
  
    <li><a href="/categories/生活/">生活</a><small>2</small></li>
  
    <li><a href="/categories/看书/">看书</a><small>1</small></li>
  
  </ul>
</div>


<!-- ע��Ĭ�Ϸ������



-->


<!-- �����������



<div class="widget tag">
  <h3 class="title">分类</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cat/">cat</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/elasticsearch/">elasticsearch</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea-IDE/">idea IDE</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java8/">java8</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kotlin/">kotlin</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/netty/">netty</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rabbitmq/">rabbitmq</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/react/">react</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/springboot/">springboot</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础/">基础</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发/">并发</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/测试/">测试</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/看书/">看书</a><span class="category-list-count">1</span></li></ul> 
</div>



-->

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/HashMap/">HashMap</a><small>1</small></li>
  
    <li><a href="/tags/NIO/">NIO</a><small>5</small></li>
  
    <li><a href="/tags/effective-java-3/">effective java 3</a><small>1</small></li>
  
    <li><a href="/tags/gradle/">gradle</a><small>1</small></li>
  
    <li><a href="/tags/grpc/">grpc</a><small>1</small></li>
  
    <li><a href="/tags/hexo/">hexo</a><small>1</small></li>
  
    <li><a href="/tags/http/">http</a><small>1</small></li>
  
    <li><a href="/tags/idea/">idea</a><small>2</small></li>
  
    <li><a href="/tags/java8/">java8</a><small>2</small></li>
  
    <li><a href="/tags/jedis/">jedis</a><small>1</small></li>
  
    <li><a href="/tags/json/">json</a><small>1</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>1</small></li>
  
    <li><a href="/tags/maven/">maven</a><small>1</small></li>
  
    <li><a href="/tags/netty源码/">netty源码</a><small>3</small></li>
  
    <li><a href="/tags/nosql/">nosql</a><small>1</small></li>
  
    <li><a href="/tags/react/">react</a><small>1</small></li>
  
    <li><a href="/tags/redis/">redis</a><small>3</small></li>
  
    <li><a href="/tags/rpc/">rpc</a><small>2</small></li>
  
    <li><a href="/tags/spel/">spel</a><small>1</small></li>
  
    <li><a href="/tags/thrift/">thrift</a><small>1</small></li>
  
    <li><a href="/tags/websocket/">websocket</a><small>2</small></li>
  
    <li><a href="/tags/健康/">健康</a><small>2</small></li>
  
    <li><a href="/tags/命令/">命令</a><small>2</small></li>
  
    <li><a href="/tags/镜像/">镜像</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2018/07/21/212047/">mongodb安装（Windows）</a>
      </li>
    
      <li>
        <a href="/2018/07/20/111747/">Dianping CAT 安装说明文档</a>
      </li>
    
      <li>
        <a href="/2018/06/29/143647/">effective java 3</a>
      </li>
    
      <li>
        <a href="/2018/06/03/142947/">spring boot笔记</a>
      </li>
    
      <li>
        <a href="/2018/04/02/211447/">轻松搭建Redis缓存高可用集群</a>
      </li>
    
  </ul>
</div>


  <div class="widget tag">
<h3 class="title">友情链接</h3>
<ul class="entry">
<li><a href="http://www.baidu.com/" title="百度">百度</a></li>
<li><a href="http://www.sina.com.cn" title="新浪">新浪</a></li>
<li><a href="http://maciektalaska.github.io" title="maciektalaska">maciektalaska</a></li>
<li><a href="http://x.bbyc.cn/" title="maciektalaska">神的禁区</a></li>


</ul>
</div>

  <iframe width="100%" height="600" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=600&fansRow=1&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=2064204680&verifier=b3464355&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  Copyright &copy; 2018 Liaowz 鄂ICP备15016859号-1
  
</div>
<div class="clearfix"></div></footer>
  <script src="https://code.jquery.com/jquery-2.0.3.js" integrity="sha256-lCf+LfUffUxr81+W0ZFpcU0LQyuZ3Bj0F2DQNCxTgSI=" crossorigin="anonymous"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
